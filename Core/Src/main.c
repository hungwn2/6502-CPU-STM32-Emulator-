/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */
#include "uart.h"
#include <stdio.h>
#include <stdint.h>
#include "osKernel.h"
#include "rom.h"


typedef uint32_t TaskProfiler;
TaskProfiler Task0_Profiler,Task1_Profiler,Task2_Profiler, pTask1_Profiler, pTask2_Profiler;
#define QUANTA 1



static cpu_t &g_cpu;
uint32_t TIM2_Ticks;
static osSemaphore_t sem_step;



typedef struct task6502 {
  cpu_t cpu;
  uint8_t stack_page[256]; // snapshot of $0100-$01FF (shared RAM case)

  task_state_t state;

  // wait-queue linkage
  struct task6502 *wait_next;

  // scheduler linkage (ready ring)
  struct task6502 *next;
} task6502_t;


static void save_stack(task6502_t *t){
  for (int i=0;i<256;i++) t->stack_page[i] = bus_read(0x0100+i);
}

static void load_stack(task6502_t *t){
  for (int i=0;i<256;i++) bus_write(0x0100+i, t->stack_page[i]);
}




void taskIdle(void){
	while(1){

	}
}


int main(void){
	//initialize kernel, and add threads

	uart_tx_init();
	tim2_1hz_interrupt_init();
	osSemaphoreInit(&semaphore1, 1);
	osSemaphoreInit(&semaphore2, 0);
	osKernelInit();
	osKernelAddThreads(&task6502, &task_stepper, &taskIdle);
	osKernelLaunch(QUANTA);

}

void TIM2_IRQHandler(void){

	if (TIM2->SR & SR_UIF) {
	    TIM2->SR &= ~SR_UIF;
	    step_count++; //Create one sem token
	    osSemaphoreSet(&sem_step);   // allow exactly one 6502 instruction
	  }
}

